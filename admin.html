<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel - Game Toán Học</title>
    <style>
        body { font-family: sans-serif; background-color: #282c34; color: white; padding: 20px; }
        .container { display: flex; gap: 30px; }
        .user-panel, .detail-panel { flex: 1; }
        #login-section, #admin-panel { padding: 20px; border: 1px solid #61dafb; border-radius: 8px; }
        #admin-panel { display: none; }
        #statistics-panel { background-color: #20232a; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #444; padding: 10px; text-align: left; }
        th { background-color: #20232a; }
        button { font-size: 14px; padding: 5px 10px; margin-right: 5px; cursor: pointer; }
        .btn-delete { background-color: #e74c3c; color: white; border: none; }
        .btn-edit { background-color: #f1c40f; color: black; border: none; }
        .btn-view { background-color: #3498db; color: white; border: none; }
        input { padding: 8px; font-size: 16px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <h1>Trang Quản Trị</h1>
    <p>Trạng thái kết nối: <b id="status" style="color: red;">Đang kết nối...</b></p>

    <div id="login-section">
        <h3>Đăng nhập Admin</h3>
        <input type="password" id="adminPassword" placeholder="Nhập mật khẩu">
        <button id="loginBtn">Đăng nhập</button>
    </div>

    <div id="admin-panel">
        
        <div id="statistics-panel">
            <h3>Thống kê Toàn hệ thống</h3>
            <p>Tổng số người dùng: <b id="stat-total-users">0</b></p>
            <p>Tổng số lượt chơi: <b id="stat-total-games">0</b></p>
            <button id="refreshStatsBtn">Làm mới Thống kê</button>
        </div>

        <div class="container">
            <div class="user-panel">
                <h2>Danh sách người chơi</h2>
                <button id="refreshUsersBtn">Làm mới danh sách</button>
                <table id="user-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Tên người chơi</th>
                            <th>Avatar ID</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="detail-panel">
                <h2>Chi tiết Lịch sử chơi</h2>
                <p id="currentUser">Chọn một người dùng để xem lịch sử.</p>
                <div id="history-data"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const socket = io('https://mathhandventures.onrender.com'); 
        
        // Lấy các element từ HTML
        const statusEl = document.getElementById('status');
        const loginSection = document.getElementById('login-section');
        const adminPanel = document.getElementById('admin-panel');
        const loginBtn = document.getElementById('loginBtn');
        const adminPasswordInput = document.getElementById('adminPassword');
        const userTableBody = document.querySelector('#user-table tbody');
        const refreshUsersBtn = document.getElementById('refreshUsersBtn');
        const currentUserEl = document.getElementById('currentUser');
        const historyDataEl = document.getElementById('history-data');

        // Thêm element cho thống kê
        const refreshStatsBtn = document.getElementById('refreshStatsBtn');
        const statTotalUsers = document.getElementById('stat-total-users');
        const statTotalGames = document.getElementById('stat-total-games');

        // --- LẮNG NGHE SỰ KIỆN TỪ SERVER ---
        socket.on('connect', () => { statusEl.textContent = 'Đã kết nối!'; statusEl.style.color = 'lime'; });

        socket.on('admin_login_success', () => {
            loginSection.style.display = 'none';
            adminPanel.style.display = 'block';
            refreshUsersBtn.click(); // Tự động làm mới danh sách
            refreshStatsBtn.click(); // Tự động làm mới thống kê
        });

        socket.on('admin_login_fail', () => { alert('Sai mật khẩu!'); });

        socket.on('admin_user_list', (data) => {
            userTableBody.innerHTML = '';
            data.users.forEach(user => {
                const row = `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.name}</td>
                        <td>${user.avatar_id}</td>
                        <td>
                            <button class="btn-view" data-id="${user.id}" data-name="${user.name}">Xem</button>
                            <button class="btn-edit" data-id="${user.id}" data-name="${user.name}">Sửa</button>
                            <button class="btn-delete" data-id="${user.id}" data-name="${user.name}">Xóa</button>
                        </td>
                    </tr>
                `;
                userTableBody.innerHTML += row;
            });
        });

        socket.on('admin_user_history_data', (data) => {
            historyDataEl.innerHTML = '';
            const mathHistory = data.history.filter(h => h.mode === 'Math');
            const countingHistory = data.history.filter(h => h.mode === 'Counting');
            historyDataEl.innerHTML += '<h3>Game Tính Toán</h3>';
            if (mathHistory.length > 0) { mathHistory.forEach(h => { historyDataEl.innerHTML += `<div>Điểm: ${h.score} (Lúc: ${h.time})</div>`; }); } else { historyDataEl.innerHTML += 'Không có dữ liệu.'; }
            historyDataEl.innerHTML += '<h3>Game Đếm Số</h3>';
            if (countingHistory.length > 0) { countingHistory.forEach(h => { historyDataEl.innerHTML += `<div>Điểm: ${h.score} (Lúc: ${h.time})</div>`; }); } else { historyDataEl.innerHTML += 'Không có dữ liệu.'; }
        });
        
        // Thêm bộ lắng nghe cho thống kê
        socket.on('admin_statistics_data', (data) => {
            statTotalUsers.textContent = data.total_users;
            statTotalGames.textContent = data.total_games;
        });

        // --- GỬI SỰ KIỆN TỚI SERVER ---
        loginBtn.onclick = () => { socket.emit('admin_login', { password: adminPasswordInput.value }); };
        refreshUsersBtn.onclick = () => { socket.emit('admin_get_all_users'); };
        
        // Thêm hành động cho nút thống kê
        refreshStatsBtn.onclick = () => {
            socket.emit('admin_get_statistics');
        };

        userTableBody.addEventListener('click', (event) => {
            const target = event.target;
            const userId = target.getAttribute('data-id');
            const userName = target.getAttribute('data-name');
            if (target.classList.contains('btn-view')) {
                currentUserEl.textContent = `Lịch sử của: ${userName} (ID: ${userId})`;
                socket.emit('admin_get_user_history', { user_id: parseInt(userId) });
            }
            if (target.classList.contains('btn-edit')) {
                const newName = prompt(`Nhập tên mới cho '${userName}':`);
                if (newName && newName.trim() !== '') {
                    socket.emit('admin_update_user_name', { user_id: parseInt(userId), new_name: newName });
                    setTimeout(() => refreshUsersBtn.click(), 500); 
                }
            }
            if (target.classList.contains('btn-delete')) {
                if (confirm(`Bạn có chắc chắn muốn xóa '${userName}' và toàn bộ lịch sử chơi?`)) {
                    socket.emit('admin_delete_user', { user_id: parseInt(userId) });
                    setTimeout(() => refreshUsersBtn.click(), 500);
                }
            }
        });
    </script>
</body>
</html>